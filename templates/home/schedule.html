{% extends "layouts/base.html" %}

{% block title %} Đặt lịch thiết bị {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
<div class="pcoded-main-container">
    <div class="pcoded-content">
        <div class="page-header">
            <div class="page-block">
                <div class="row align-items-center">
                    <div class="col-md-12">
                        <div class="page-header-title">
                            <h5 class="m-b-10">Đặt lịch thiết bị</h5>
                        </div>
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="#">Đặt lịch</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Form đặt lịch -->
        <div class="row">
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header"><h5>Thêm lịch mới</h5></div>
                    <div class="card-body">
                        <form id="schedule-form">
                            <div class="form-group">
                                <label for="device">Thiết bị</label>
                                <input type="text" class="form-control" id="device" name="device" placeholder="Ví dụ: Tu-1" required>
                            </div>
                            <div class="form-group">
                                <label for="command">Lệnh</label>
                                <input type="text" class="form-control" id="command" name="command" placeholder="Ví dụ: Relay1" required>
                            </div>
                            <div class="form-group">
                                <label for="state">Trạng thái</label>
                                <select class="form-control" id="state" name="state" required>
                                    <option value="true">Bật</option>
                                    <option value="false">Tắt</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="time">Thời gian</label>
                                <input type="datetime-local" class="form-control" id="time" name="time" required>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">Thêm lịch</button>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Bảng lịch trình -->
            <div class="col-sm-6">
                <div class="card">
                    <div class="card-header"><h5>Lịch trình đã đặt</h5></div>
                    <div class="card-body">
                        <table class="table table-bordered" id="schedule-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Thiết bị</th>
                                    <th>Lệnh</th>
                                    <th>Trạng thái</th>
                                    <th>Thời gian</th>
                                    <th>Xóa</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Lịch trình sẽ được render ở đây -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
function fetchSchedules() {
    fetch('/api/schedule')
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector('#schedule-table tbody');
            tbody.innerHTML = '';
            data.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${idx+1}</td>
                    <td>${item.device}</td>
                    <td>${item.command}</td>
                    <td>${item.state === 'true' ? 'Bật' : 'Tắt'}</td>
                    <td>${item.time}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteSchedule(${idx})">Xóa</button></td>
                `;
                tbody.appendChild(tr);
            });
        });
}

function deleteSchedule(id) {
    fetch(`/api/schedule/${id}`, {method: 'DELETE'})
        .then(res => res.json())
        .then(() => fetchSchedules());
}

document.getElementById('schedule-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const data = {
        device: this.device.value,
        command: this.command.value,
        state: this.state.value,
        time: this.time.value
    };
    fetch('/api/schedule', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(() => {
        this.reset();
        fetchSchedules();
    });
});

// Tải lịch trình khi trang được load
document.addEventListener('DOMContentLoaded', fetchSchedules);
</script>
{% endblock javascripts %}
